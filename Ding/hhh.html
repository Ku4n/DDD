<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lunch</title>
    <!--<script type="text/javascript" src="http://g.alicdn.com/dingding/dingtalk-pc-api/2.3.1/index.js" ></script>-->
    <script type="text/javascript" src="http://g.alicdn.com/dingding/open-develop/1.6.9/dingtalk.js" ></script>
    <script type="text/javascript" src="https://g.alicdn.com/dingding/dingtalk-pc-api/2.7.0/index.js"></script>
</head>
<body>
<div id="box"></div>
<div id="box1"></div>
<div id="box2"></div>
<div id="box3"></div>
<div id="box4"></div>
<div id="data"></div>



</body>
</html>
<script type="text/javascript">

/*     dd.ready(function(){
         dd.device.notification.confirm({
             message: "你爱我吗",
             title: "提示",
             buttonLabels: ['爱', '不爱'],
             onSuccess : function(result) {
                 //onSuccess将在点击button之后回调
                 {
                     buttonIndex: 0 //被点击按钮的索引值，Number类型，从0开始
                 }
             },
             onFail : function(err) {}
         });


     });*/


    window.onload = function () { //http://devding.sport147.cn/Ding/hhh.html
        var config_data;
        function a (){
            // var url = 'http://localhost/Ding/public/index/index/index';
            var url = 'http://devding.sport147.cn/?m=Home&c=Index&a=sign';



            var myHeaders = {
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                method: 'GET',
            };
            fetch(url,myHeaders).then(function(ret){
                return ret.json();
            }).then(function (data) {
                // console.log(data);
                //document.getElementById('box').innerHTML = data.agentid;

                b(data);
            })
        }
        a();

        function b(data) {
            // console.log('ghgfh');
            // console.log(data);
/*            document.getElementById('box').innerHTML = data.agentid;
            document.getElementById('box1').innerHTML = data.corpid;
            document.getElementById('box2').innerHTML = data.noncestr;
            document.getElementById('box3').innerHTML = data.signature;
            document.getElementById('box4').innerHTML = data.timeStamp;*/


            var _config = {
                agentId: data.agentid,
                corpId: data.corpid,
                timeStamp: data.timeStamp,
                nonceStr: data.noncestr,
                signature: data.signature,
            }


            // console.log(_config);

            DingTalkPC.config({
                agentId: _config.agentId,
                corpId: _config.corpId,
                timeStamp: _config.timeStamp,
                nonceStr: _config.nonceStr,
                signature: _config.signature,
                jsApiList: [
                    'runtime.permission.requestAuthCode', // 获取code
                    'device.notification.alert', //  alert 弹窗
                    'device.notification.confirm', // confirm 弹窗
                    'biz.contact.choose', // 选人
                    'device.notification.prompt', // prompt弹窗
                    'biz.ding.post', // 发钉钉消息
                    'biz.user.get', //获取用户信息

                ]
            });

            DingTalkPC.ready(function() {

                DingTalkPC.runtime.permission.requestAuthCode({
                    corpId: _config.corpId,
                    onSuccess: function(result) {

                            console.log(result);
                            document.getElementById('box').innerHTML = result.code;

/*                            var url = 'http://devding.sport147.cn/?m=Home&c=Index&a=get_code';

                            var myHeaders = {
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                },
                                method: 'POST',
                                body: JSON.stringify({
                                    code: result.code,
                                })
                            }*/



                        fetch(url,myHeaders).then(function(ret){
                            return ret.json();
                        }).then(function (data) {
                            // console.log(data);
                            //document.getElementById('box').innerHTML = data.agentid;


                        })

                    },
                    onFail : function(err) {
                        console.log('获取code失败');
                    }

                });

                DingTalkPC.biz.user.get({
                    corpId:_config.corpId, // 可选参数，如果不传则使用用户当前企业的corpId。
                    onSuccess: function (info) {
                        console.log(info);
                        document.getElementById('box1').innerHTML = info.nickName;
                        document.getElementById('box2').innerHTML = info.emplId;

/*                        Ext.Ajax.request(
                            {
                                nickName : info.nickName,
                                openId : info.emplId,
                            },
                            success:function (response) {

                        }
                        )*/

                        //logger.e('userGet success: ' + JSON.stringify(info));
                    },
                    onFail: function (err) {
                        //logger.e('userGet fail: ' + JSON.stringify(err));
                    }
                });

            });

            DingTalkPC.error(function(err) {
                alert('DingTalkPC error: ' + JSON.stringify(err));
            });


/*            DingTalkPC.ready(function() {

                DingTalkPC.runtime.permission.requestOperateAuthCode({
                    corpId: _config.corpid,
                    agentId:_config.agentid,
                    onSuccess: function(result) {
                        console.log(result);
                    },
                    onFail : function(err) {}

                })

            });

            DingTalkPC.error(function(err) {
                alert('DingTalkPC error: ' + JSON.stringify(err));
            });*/







        }


    }

</script>